#!/bin/bash

# Script pour appliquer les modifications de schÃ©ma Prisma
# Ajout des fonctionnalitÃ©s de sÃ©curitÃ© : bannissement et dÃ©tection de malware

echo "ğŸ”„ Mise Ã  jour du schÃ©ma de base de donnÃ©es..."
echo ""

# 1. ArrÃªter l'application temporairement
echo "â¸ï¸  ArrÃªt de l'application..."
pm2 stop newshare

# 2. GÃ©nÃ©rer le client Prisma avec le nouveau schÃ©ma
echo ""
echo "ğŸ”§ GÃ©nÃ©ration du client Prisma..."
npx prisma generate

# 3. Appliquer les migrations
echo ""
echo "ğŸ“¦ Application des migrations..."
npx prisma migrate deploy || {
  echo "âš ï¸  Ã‰chec de la migration automatique"
  echo "ğŸ”§ Tentative avec prisma db push..."
  npx prisma db push --accept-data-loss
}

# 4. RedÃ©marrer l'application
echo ""
echo "ğŸš€ RedÃ©marrage de l'application..."
pm2 restart newshare
pm2 save

# 5. VÃ©rifier les logs
echo ""
echo "ğŸ“‹ VÃ©rification des logs..."
pm2 logs newshare --lines 20

echo ""
echo "âœ… Mise Ã  jour terminÃ©e !"
echo ""
echo "ğŸ”’ Nouvelles fonctionnalitÃ©s activÃ©es :"
echo "  - Scan automatique de malware lors de l'upload"
echo "  - Bannissement automatique en cas de dÃ©tection"
echo "  - Historique des tentatives de malware"
echo ""

